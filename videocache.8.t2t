VIDEO-CACHE

%%date(%B %d, %Y)
%!postproc(man): "^(\.TH.*) 1 "  "\1 8 "

= NAME =

Videocache - Squid url rewriter plugin to cache dynamic audio/video content from different video portals/websites.

= DESCRIPTION =

Videocache is a squid url rewriter plugin written in Python to facilitate caching youtube, metacafe, dailymotion, google, vimeo, redtube, xtube, youporn, msn soapbox, tube8, blip.tv, break.com and wrzuta.pl videos. It can cache videos from various websites in a separate directory (other than squid cache), in a browsable fashion and can serve the subsequent requests from the cache. It helps in saving bandwidth and reducing load time of the videos. Videocache is currently used by a number of ISPs in various parts of the world.

= DEPENDENCIES =
```
1. squid >= 2.6
2. python >= 2.4
3. python-iniparse
4. Apache or any other Web Server
```
= INSTALLATION =
See INSTALL file in Videocache source for installation instructions.

= CONFIGURATION =

To use Videocache, you need to configure Proxy Server (squid) and the global videocache configuration file. Below are the steps to configure videocache.

== SQUID CONFIGURATION ==

To configure squid to use Videocache as a url rewriter program, you need to add the following lines to your squid configuration file (generally found at ///etc/squid/squid.conf//):
```
# --BEGIN-- videocache config for squid
url_rewrite_program /usr/bin/python /usr/share/videocache/videocache.py
url_rewrite_children 15 startup=15

acl videocache_allow_url url_regex -i \.youtube\.com\/videoplay \.youtube\.com\/get_video\?
acl videocache_allow_url url_regex -i \.youtube\.[a-z][a-z]\/videoplay \.youtube\.[a-z][a-z]\/get_video\?
acl videocache_allow_url url_regex -i \.youtube\.[a-z][a-z]\.[a-z][a-z]\/videoplay \.youtube\.[a-z][a-z]\.[a-z][a-z]\/get_video\?
acl videocache_allow_url url_regex -i \.googlevideo\.com\/videoplay \.googlevideo\.com\/get_video\?
acl videocache_allow_url url_regex -i \.google\.com\/videoplay \.google\.com\/get_video\?
acl videocache_allow_url url_regex -i \.google\.[a-z][a-z]\/videoplay \.google\.[a-z][a-z]\/get_video\?
acl videocache_allow_url url_regex -i \.google\.[a-z][a-z]\.[a-z][a-z]\/videoplay \.google\.[a-z][a-z]\.[a-z][a-z]\/get_video\?
acl videocache_allow_url url_regex -i \.mccont\.com\/ItemFiles\/(.*)?\.(flv|mp4|avi|mkv|mp3|rm|rmvb|m4v|mov|wmv|3gp|mpg|mpeg)
acl videocache_allow_url url_regex -i proxy[a-z0-9\-]?[a-z0-9]?[a-z0-9]?[a-z0-9]?\.dailymotion\.com\/(.*)\.(flv|on2|mp4|avi|mkv|mp3|rm|rmvb|m4v|mov|wmv|3gp|mpg|mpeg)
acl videocache_allow_url url_regex -i vid\.akm\.dailymotion\.com\/(.*)\.(flv|on2|mp4|avi|mkv|mp3|rm|rmvb|m4v|mov|wmv|3gp|mpg|mpeg)
acl videocache_allow_url url_regex -i cdn\.dailymotion\.com\/(.*)\.(flv|on2|mp4|avi|mkv|mp3|rm|rmvb|m4v|mov|wmv|3gp|mpg|mpeg)
acl videocache_allow_url url_regex -i redtube\.com\/(.*)\.(flv|mp4|avi|mkv|mp3|rm|rmvb|m4v|mov|wmv|3gp|mpg|mpeg)
acl videocache_allow_url url_regex -i \.xtube\.com\/(.*)\.(flv|mp4|avi|mkv|mp3|rm|rmvb|m4v|mov|wmv|3gp|mpg|mpeg)
acl videocache_deny_url  url_regex -i \.xtube\.com\/(.*)(Thumb|videowall)
acl videocache_allow_url url_regex -i \.vimeo\.com\/(.*)\.(flv|mp4|avi|mkv|mp3|rm|rmvb|m4v|mov|wmv|3gp|mpg|mpeg)
acl videocache_allow_url url_regex -i \.amazonaws\.com\/(.*)\.vimeo\.com(.*)\.(flv|mp4|avi|mkv|mp3|rm|rmvb|m4v|mov|wmv|3gp|mpg|mpeg)
acl videocache_allow_url url_regex -i c\.wrzuta\.pl\/(.*)\.(flv|mp4|avi|mkv|mp3|rm|rmvb|m4v|mov|wmv|3gp|mpg|mpeg)
acl videocache_allow_url url_regex -i c\.wrzuta\.pl\/wa[0-9][0-9]?[0-9]?[0-9]?[0-9]?
acl videocache_allow_url url_regex -i \.youporn\.com\/(.*)\.(flv|mp4|avi|mkv|mp3|rm|rmvb|m4v|mov|wmv|3gp|mpg|mpeg)
acl videocache_allow_url url_regex -i msn\.com\/(.*)\.(flv|mp4|avi|mkv|mp3|rm|rmvb|m4v|mov|wmv|3gp|mpg|mpeg)
acl videocache_allow_url url_regex -i msn\.(.*)\.(com|net)\/(.*)\.(flv|mp4|avi|mkv|mp3|rm|rmvb|m4v|mov|wmv|3gp|mpg|mpeg)
acl videocache_allow_url url_regex -i msnbc\.(.*)\.(com|net)\/(.*)\.(flv|mp4|avi|mkv|mp3|rm|rmvb|m4v|mov|wmv|3gp|mpg|mpeg)
acl videocache_allow_url url_regex -i \.tube8\.com\/(.*)\.(flv|mp4|avi|mkv|mp3|rm|rmvb|m4v|mov|wmv|3gp|mpg|mpeg)
acl videocache_allow_url url_regex -i \.blip\.tv\/(.*)\.(flv|mp4|avi|mkv|mp3|rm|rmvb|m4v|mov|wmv|3gp|mpg|mpeg)
acl videocache_deny_url  url_regex -i \.blip\.tv\/(.*)filename
acl videocache_allow_url url_regex -i \.break\.com\/(.*)\.(flv|mp4|avi|mkv|mp3|rm|rmvb|m4v|mov|wmv|3gp|mpg|mpeg)
acl videocache_deny_url  url_regex -i crossdomain.xml
acl videocache_method method GET
url_rewrite_access deny  videocache_deny_url
url_rewrite_access allow videocache_method videocache_allow_url
url_rewrite_access deny all
url_rewrite_bypass on
# --END-- videocache config for squid
```
After changes, reload or restart the squid service using the command:
```
[root@proxy ~]# /etc/init.d/squid reload [ENTER]
```
OR
```
[root@proxy ~]# /etc/init.d/squid restart [ENTER]
```

== VIDEO-CACHE GLOBAL CONFIGURATION ==

Config file : /etc/videocache.conf

: enable_videocache
This option controls the global behavior of videocache plugin. If it is 0, videocache will stop caching or serving anything. This option's value can be either 0 or 1. Default: 1.

: offline_mode
When Offline Mode is enabled, Videocache will serve the videos already in cache and will skip caching the new videos. When set to 0, Videocache will cache new video and when set to 1, Videocache will serve the already cached videos and will not cache the new videos is encounters. Default: 0.

: videocache_user
Use this option to set the user which should be running Videocache scheduler. This user must be same as the squid user. On RedHat/CentOS/SuSE, it's generally //squid// and on Debian/Ubuntu/BSDs, it generally //proxy//. Default: //squid//.

**IMPORTANT** : This must be set appropriately otherwise videocache will not work.

: cache_host
The hostname or IP address of the system on which caching is being done. This is used for serving the videos from the cache.

**IMPORTANT** : Please don’t use http:// or slashes (/). Just specify the domain name or IP address.
Additionally you can select an alternative port to use.
```
Example : proxy.example.com
or 192.168.36.204
or 192.168.36.204:81
or <Proxy_Server_IP_OR_Domain:HTTP_PORT>
```
Default: 127.0.0.1.

: base_dir
Base directories for caching the videos. You can specify multiple caching directories here separated by '|' symbol. Please try to avoid special characters in directory names like spaces, $ etc.
``` Example : base_dir = /var/spool/videocache/ | /videocache2/stuff-new/|/new_videocache.
Default: ///var/spool/videocache///.

: max_cache_processes
The maximum number of parallel cache processes allowed. If all connections are consumed, videos will be queued for caching. Default: 20.

: proxy
**Warning** : __**USE THIS ONLY IF**__ Videocache Server should go via anohter proxy.

Proxy for http content. Default: <blank>.
```
Example : http_proxy = http://<Proxy_Server_IP_OR_Domain>:<Proxy_port>/
or http://proxy.example.com:3128/
```

: proxy_username
If the above proxy requires authentication, please specify the username. Default: <blank>.

: proxy_password
If the above proxy requires authentication, please specify the password. Default: <blank>.

: hit_threshold
No of times a video should be requested before we start caching it. Default: 2

: max_video_size
The video of size more than //max_video_size// (MegaBytes) will not be cached. Default: 0.
``` EXAMPLE: If max_video_size = 50, Videocache will not cache videos of size more than 50MB.  Set this to 0 to disable this check. Don't append MB.

: min_video_size
The video of size less than //min_video_size// (MegaBytes) will not be cached. Default: 0.
``` EXAMPLE: If min_video_size = 2, videocache will not cache videos of size less than 2MB.  Set this to 0 to disable this check. Don't append MB.

: disk_avail_threshold
This option sets the minimum available free space in Mega Bytes that is left in a partition containing a cache directory before videocache treats that partition as FULL. Default: 1000.
``` EXAMPLE: If disk_avail_threshold = 200, videocache will stop caching videos in a cache directory if the free space available in that cache directory is less than 200 Mega Bytes.

: enable_videocache_cleaner
Enables the videocache cleaner script which will remove videos from cache which have not been used since long. The value of this option can be 0 or 1. Default: 1.

: video_lifetime
The maximum life of a video in cache without being used. If the video was not accessed for more than //video_lifetime// days, it'll be removed from the cache. The unit of video_lifetime is days. Default: 30.
``` Example : video_lifetime = 15 will remove videos which were not used since last 15 or more days.

: logformat, scheduler_logformat, cleaner_logformat
Logformat allows you to get log messages in your preferred format. The //logformat//, //scheduler_logformat//, //cleaner_logformat// are applicable to main videocache log, scheduler log and cleaner log respectively. Use the format codes described below.
```
%  - A literal % character
ts - Seconds since epoch
tu - Time in millisecond
tl - Local Time
tg - GMT Time
p  - Process ID of the process logging the message
s  - Severity level of the log message
i  - Client's IP address
w  - Website ID (eg. YOUTUBE/GOOGLE/VIMEO etc.)
c  - Status Code (CACHE_HIT/CACHE_MISS etc.)
v  - Video ID of current video
m  - Additional Message (for verbose logs)
d  - Debug message (for debugging purpose)
```
``` Example: logformat = %ts %i %w %c %v
Default logformats: 
```
logformat = %tl %p %s %i %w %c %v %m %d
scheduler_logformat =  %tl %p %s %i %w %c %v %m %d
cleaner_logformat = %tl %p %s %w %c %v %m %d
```

: timeformat
You can use a custom format for displaying time in log messages. Use the format codes described below

**IMPORTANT** : This format will be applicable to localtime and GMT time in the log messages.
```
%a    Abbreviated weekday name (Sun, Mon, Tue, Wed, Thu, Fri, Sat)
%A    Full weekday name (Sunday, Monday, ...)
%b    Abbreviated month name (Jan, Feb, Mar, ...)
%B    Full month name (January, February, ...)
%d    Day of the month as a decimal number [01..31]
%H    Hour (24-hour clock) as a decimal number [00..23]
%I    Hour (12-hour clock) as a decimal number [01..12]
%j    Day of the year as a decimal number [001..366]
%m    Month as a decimal number [01..12]
%M    Minute as a decimal number [00..59]
%p    Either AM or PM
%S    Second as a decimal number [00..59]
%y    Year without century as a decimal number [00..99]
%Y    Year with century as a decimal number
```
``` Example: timeformat = %B %d, %Y %H:%M:%S
Default: %d/%b/%Y:%H:%M:%S

: logdir

Directory where videocache logs will be stored. Default: ///var/log/videocache///.

: logfile, scheduler_logfile, cleaner_logfile, tracefile
The name of log file can be specified using different logfile options. Please avoid any special characters in filename.

Default logfile names:
```
logfile : videocache.log
scheduler_logfile : scheduler.log
cleaner_logfile : cleaner.log
tracefile : trace.log
```

: max_logfile_size, max_scheduler_logfile_size, max_cleaner_logfile_size, max_tracefile_size
Maximum size of logfiles specified above. The size is in mega bytes.

**IMPORTANT** : Please don't use max_logfile_size = 10MB. Don't append MB.

Default logfile sizes:
```
max_logfile_size : 10
max_scheduler_logfile_size : 10
max_cleaner_logfile_size : 10
max_tracefile_size : 10
```

: max_logfile_backups, max_scheduler_logfile_backups, max_cleaner_logfile_backups, max_tracefile_backups
The logfiles are automatically rotated once they have exceeded the //max_logfile_size//. The //max_logfile_backups// is the number of backup files you want to keep.
``` Example: max_logfile_backups = 2 will keep videocache.log and videocache.log.1 and videocache.log.2 as logfiles.
Default logfile backups:
```
max_logfile_backups : 10
max_scheduler_logfile_backups : 10
max_cleaner_logfile_backups : 5
max_tracefile_backups : 1
```

: scheduler_pidfile
The //scheduler_logfile// option can be used to specify the location of a file which will be used to track process ID of the currently running Videocache scheduler. Default: ///var/run/videocache.pid//.

: enable_youtube_cache
This option enables the caching of Youtube videos. This option’s value can be either 0 or 1. Default: 1.

: temp_dir
Directory to store partially downloaded videos. Directory name is relative to //base_dir//. Default: //tmp//.
``` Example: If temp_dir = tmp, actual path for storing partially downloaded videos would be /var/spool/videocache/tmp/.

: rpc_host
XMLRPCServer is used for memory sharing across different instances of videocache. Leave these settings as it is if you don’t have a fair idea of XMLRPCServer. This will be same as cache_host in almost all the cases. Default: 127.0.0.1.

: rpc_port
Please make sure this port is not currently in use. If it is in use by some other program, change this to some port above 1024 which is not in use by any other program. Default: 9100.


= FILES =
```
/etc/videocache.conf
/etc/httpd/conf.d/videocache.conf OR /etc/apache2/conf.d/videocache.conf
/usr/share/videocache/
/usr/share/man/man8/videocache.8.gz
/usr/sbin/vc-update
/usr/sbin/vc-scheduler
/usr/sbin/vc-cleaner
/var/log/videocache/
/var/spool/videocache/
/var/run/videocache.pid
```
= SEE ALSO =
```
squid (8)

Project Website : http://cachevideos.com/
How to configure squid : http://gofedora.com/how-to-configure-squid-proxy-server/
```
= AUTHOR =
```
Kulbir Saini <saini@saini.co.in>
```

= BUGS, SUGGESTIONS, COMMENTS =
```
Please visit http://cachevideos.com/forum/.
```
